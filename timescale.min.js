(function(){var d={getPath:function(){var e=document.currentScript?document.currentScript.src:function(){var e=document.scripts,i=e.length-1,t;for(var n=i;n>0;n--){if(e[n].readyState==="interactive"){t=e[n].src;break}}return t||e[i].src}();return e.substring(0,e.lastIndexOf("/")+1)}(),getStyle:function(e,i){return window.getComputedStyle(e)[i]},link:function(e,i,t){if(!l.path)return;var n=document.getElementsByTagName("head")[0],a=document.createElement("link");if(typeof i==="string")t=i;var o=(t||e).replace(/\.|\//g,"");var r="timescale-"+o,s=0;a.rel="stylesheet";a.href=l.path+e;a.id=r;if(!document.getElementById(r)){n.appendChild(a)}if(typeof i!=="function")return;(function e(){if(++s>8*1e3/100){return window.console||console.error("timescale.css: Invalid")}parseInt(d.getStyle(document.getElementById(r),"width"))===1989?i():setTimeout(e,100)})()},script:function(e,i,t){if(!l.path)return;if(typeof i==="string")t=i;var n=(t||e).replace(/\.|\//g,"");var a="timescale-"+n,o=0;var r=document.createElement("script");r.type="text/javascript";r.src=l.path+e;r.id=a;if(!document.getElementById(a)){document.body.appendChild(r)}if(typeof i!=="function")return;(function e(){if(++o>8*1e3/100){return window.console||console.error("konva.js: Invalid")}window.Konva?i():setTimeout(e,100)})()}},l={v:"1.0.0",config:{},path:!window.Konva?d.getPath:"",set:function(e){var i=this;i.config=v.extend({},i.config,e);return i},ready:function(e){if(!window.Konva){var i="timescale",t="css/timescale.css?v="+l.v;d.link(t,i);d.script("js/konva.min.js",e,"konva")}else if(typeof e==="function"){e()}}},h="#141F39",p="#fff",f="#097DB1",n="#FF6600",t=function(){var e=this;return{config:e.config,reload:e.reload.bind(e),seekTo:e.seekTo.bind(e),play:e.play.bind(e),pause:e.pause.bind(e),createIndex:e.createIndex.bind(e),on:e.on.bind(e),off:e.off.bind(e)}},a=function(e){var i=this;i.config=v.extend({},i.config,l.config,e);h=i.config.backgroundColor||h;p=i.config.fontColor||p;f=i.config.fontColor||f;n=i.config.cursorColor||n;this.konva={stage:null,layer:null,staticLayer:null,clipGroup:null,indexGroup:null,delClipEle:[],delIndexEle:[]};i.eventListObj={};i.containerWidth=0;i.containerHeight=0;i.mainTopBottomMargin=20;i.aTotalTime=60*60*1e3;i.currentTime=0;i.scale=1;i.maxScale=false;i.clippedArr=[];i.indexArr=[];i.m_nBeginTime=0;i.m_nTotalTime=0;l.ready(function(){i.init()})},v=function(e){return new o(e)},o=function(e){var i=0,t=typeof e==="object"?[e]:(this.selector=e,document.querySelectorAll(e||null));for(;i<t.length;i++){this.push(t[i])}};v.extend=function(){var e=1,i=arguments,n=function(e,i){e=e||(i.constructor===Array?[]:{});for(var t in i){e[t]=i[t]&&i[t].constructor===Object?n(e[t],i[t]):i[t]}return e};i[0]=typeof i[0]==="object"?i[0]:{};for(;e<i.length;e++){if(typeof i[e]==="object"){n(i[0],i[e])}}return i[0]};v.each=function(e,i){var t,n=this;if(typeof i!=="function")return n;e=e||[];if(e.constructor===Object){for(t in e){if(i.call(e[t],t,e[t]))break}}else{for(t=0;t<e.length;t++){if(i.call(e[t],t,e[t]))break}}return n};v.digit=function(e,i){var t="";e=String(e);i=i||2;for(var n=e.length;n<i;n++){t+="0"}return e<Math.pow(10,i)?t+(e|0):e};v.throttle=function(n,a){var o,r;return function(){var e=this;var i=arguments;var t=+new Date;if(o&&t<o+a){clearTimeout(r);r=setTimeout(function(){n.apply(e,i)},a)}else{o=t;n.apply(e,i)}}};v.msToHMS=function(e){var i,t,n,e=e/1e3;i=parseInt(e/(60*60));t=parseInt(e%(60*60)/60);n=parseInt(e%60);return v.digit(i,2)+":"+v.digit(t,2)+":"+v.digit(n,2)};o.prototype=[];o.prototype.constructor=o;o.addStr=function(t,e){t=t.replace(/\s+/," ");e=e.replace(/\s+/," ").split(" ");v.each(e,function(e,i){if(!new RegExp("\\b"+i+"\\b").test(t)){t=t+" "+i}});return t.replace(/^\s|\s$/,"")};o.removeStr=function(n,e){n=n.replace(/\s+/," ");e=e.replace(/\s+/," ").split(" ");v.each(e,function(e,i){var t=new RegExp("\\b"+i+"\\b");if(t.test(n)){n=n.replace(t,"")}});return n.replace(/\s+/," ").replace(/^\s|\s$/,"")};o.prototype.find=function(n){var a=this;var o=0,r=[],s=typeof n==="object";this.each(function(e,i){var t=s?[n]:i.querySelectorAll(n||null);for(;o<t.length;o++){r.push(t[o])}a.shift()});if(!s){a.selector=(a.selector?a.selector+" ":"")+n}v.each(r,function(e,i){a.push(i)});return a};o.prototype.each=function(e){return v.each.call(this,this,e)};o.prototype.addClass=function(t,n){return this.each(function(e,i){i.className=o[n?"removeStr":"addStr"](i.className,t)})};o.prototype.removeClass=function(e){return this.addClass(e,true)};o.prototype.hasClass=function(t){var n=false;this.each(function(e,i){if(new RegExp("\\b"+t+"\\b").test(i.className)){n=true}});return n};o.prototype.css=function(e,i){for(var t=0;t<this.length;t++){this[t].style[e]=i}return this};o.prototype.attr=function(t,n){var e=this;return n===undefined?function(){if(e.length>0)return e[0].getAttribute(t)}():e.each(function(e,i){i.setAttribute(t,n)})};o.prototype.removeAttr=function(t){return this.each(function(e,i){i.removeAttribute(t)})};o.prototype.html=function(t){return this.each(function(e,i){i.innerHTML=t})};o.prototype.val=function(t){return this.each(function(e,i){i.value=t})};o.prototype.append=function(t){return this.each(function(e,i){typeof t==="object"?i.appendChild(t):i.innerHTML=i.innerHTML+t})};o.prototype.remove=function(t){return this.each(function(e,i){t?i.removeChild(t):i.parentNode.removeChild(i)})};o.prototype.on=function(t,n){return this.each(function(e,i){i.attachEvent?i.attachEvent("on"+t,function(e){e.target=e.srcElement;n.call(i,e)}):i.addEventListener(t,n,false)})};o.prototype.off=function(t,n){return this.each(function(e,i){i.detachEvent?i.detachEvent("on"+t,n):i.removeEventListener(t,n,false)})};a.prototype.drawLineF=function(e){var i=0;var t=0;var n=0;var a=14;var o=this.m_nTotalTime;var r=this.m_nBeginTime;var s=0;if(o>60*60*1e3){n=10*60*1e3;do{i=parseInt(o/n);t=o%n*(this.containerWidth/o);n*=2}while(i>a);n/=2}else if(o>a*10*1e3){n=20*1e3;i=a+1;for(var l=0;l<3&&i>a;l++){i=parseInt(o/n);t=o%n*(this.containerWidth/o);n+=20*1e3}n-=20*1e3;if(i>a){n=5*60*1e3;i=parseInt(o/n);t=o%n*(this.containerWidth/o)}}else{n=10*1e3;i=parseInt(o/n);t=o%n*(this.containerWidth/o)}if(i==1){this.maxScale=true}s=(this.containerWidth-t)/i;var c=s*(r%n/n);var m=parseInt(r/n)*n;var d=0;for(var l=0;l<=i+(t>0?1:0);l++){d=s*l-c;this.drawBigCell(e,d,s,m);m+=n}};a.prototype.drawBigCell=function(e,i,t,n){var a=this;var o=new Konva.Text({x:i+2,y:a.containerHeight-a.mainTopBottomMargin-14,text:v.msToHMS(n),fontSize:14,fill:p});e.add(o);var r=new Konva.Line({points:[i,a.mainTopBottomMargin,i,a.containerHeight-a.mainTopBottomMargin],stroke:f,strokeWidth:1});e.add(r);r=new Konva.Line({points:[i+t,a.mainTopBottomMargin,i+t,a.containerHeight-a.mainTopBottomMargin],stroke:f,strokeWidth:1});e.add(r);r=new Konva.Line({points:[i+t/2,a.mainTopBottomMargin+20,i+t/2,a.containerHeight-a.mainTopBottomMargin-20],stroke:f,strokeWidth:1});e.add(r);var s=(t/10).toFixed(2);for(var l=1;l<=10;l++){if(l===5){continue}r=new Konva.Line({points:[i+s*l,a.mainTopBottomMargin+35,i+s*l,a.containerHeight-a.mainTopBottomMargin-35],stroke:f,strokeWidth:1});e.add(r)}};a.prototype.drawCursor=function(e){var i=this.currentTime;if(i>this.aTotalTime){this.currentTime=this.aTotalTime;return}v(".timescale .current-time").html(v.msToHMS(i));if(this.arrow){this.arrow.remove()}if(i>=this.m_nBeginTime&&i<=this.m_nBeginTime+this.m_nTotalTime){var t=(i-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth;this.arrow=new Konva.Arrow({points:[t,1,t,this.containerHeight-2],pointerLength:15,pointerWidth:15,fill:n,stroke:n,strokeWidth:2,pointerAtBeginning:true});e.add(this.arrow)}};a.prototype.drawClipBlock=function(e){var a=this;var i=this.clippedArr;var t=this.m_nBeginTime+this.m_nTotalTime;var n,o,r,s,l,c,m;var d,h;if(this.konva.clipGroup){this.konva.clipGroup.removeChildren()}for(var p=0,f=i.length;p<f;p++){if(i[p].startTime>=this.m_nBeginTime&&i[p].endTime<=t){c=(i[p].startTime-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth;m=(i[p].endTime-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth-c;n=new Konva.Rect({x:c,y:this.mainTopBottomMargin+20,width:m,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(255, 0, 0, 0.4)",name:"clip_"+p});o=new Konva.Line({points:[c+6,this.mainTopBottomMargin+20,c,this.mainTopBottomMargin+20,c,this.containerHeight-this.mainTopBottomMargin-20,c+6,this.containerHeight-this.mainTopBottomMargin-20],stroke:"red",strokeWidth:2,name:"clip_"+p});r=new Konva.Line({points:[c+m-6,this.mainTopBottomMargin+20,c+m,this.mainTopBottomMargin+20,c+m,this.containerHeight-this.mainTopBottomMargin-20,c+m-6,this.containerHeight-this.mainTopBottomMargin-20],stroke:"red",strokeWidth:2,name:"clip_"+p});s=new Konva.Rect({x:c,y:this.mainTopBottomMargin+20,width:6,height:this.containerHeight-this.mainTopBottomMargin*2-40,name:"clip_"+p});l=new Konva.Rect({x:c+m-6,y:this.mainTopBottomMargin+20,width:6,height:this.containerHeight-this.mainTopBottomMargin*2-40,name:"clip_"+p})}else if(i[p].startTime<this.m_nBeginTime){m=(i[p].endTime-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth;n=new Konva.Rect({x:0,y:this.mainTopBottomMargin+20,width:m,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(255, 0, 0, 0.4)",name:"clip_"+p});r=new Konva.Line({points:[m-6,this.mainTopBottomMargin+20,m,this.mainTopBottomMargin+20,m,this.containerHeight-this.mainTopBottomMargin-20,m-6,this.containerHeight-this.mainTopBottomMargin-20],stroke:"red",strokeWidth:2,name:"clip_"+p});l=new Konva.Rect({x:m-6,y:this.mainTopBottomMargin+20,width:6,height:this.containerHeight-this.mainTopBottomMargin*2-40,name:"clip_"+p})}else if(i[p].endTime>t){c=(i[p].startTime-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth;m=this.containerWidth-c;n=new Konva.Rect({x:c,y:this.mainTopBottomMargin+20,width:m,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(255, 0, 0, 0.4)",name:"clip_"+p});o=new Konva.Line({points:[c+6,this.mainTopBottomMargin+20,c,this.mainTopBottomMargin+20,c,this.containerHeight-this.mainTopBottomMargin-20,c+6,this.containerHeight-this.mainTopBottomMargin-20],stroke:"red",strokeWidth:2,name:"clip_"+p});s=new Konva.Rect({x:c,y:this.mainTopBottomMargin+20,width:6,height:this.containerHeight-this.mainTopBottomMargin*2-40,name:"clip_"+p})}n.on("click",function(e){var i=this.getName();if(!this.hasOwnProperty("checked")){this.checked=false}if(this.checked===false){this.checked=true;this.setAttr("fill","rgba(100, 0, 0, 0.6)");a.konva.delClipEle.push("."+i)}else if(this.checked===true){this.checked=false;this.setAttr("fill","rgba(255, 0, 0, 0.4)");a.konva.delClipEle.splice(a.konva.delClipEle.indexOf("."+i),1)}a.konva.layer.draw()});this.konva.clipGroup.add(n);if(o){s.on("mousedown",function(e){var n=this.getName();d=e.evt.clientX;function i(e){h=e.clientX;var i=Math.round((h-d)/a.containerWidth*a.m_nTotalTime);var t=n.split("_")[1];if(i+a.clippedArr[t].startTime>=a.clippedArr[t].endTime){a.clippedArr[t].startTime=a.clippedArr[t].endTime}else{a.clippedArr[t].startTime+=i}a.drawClipBlock(a.konva.layer);a.konva.layer.batchDraw();d=h}document.onmousemove=i});s.on("mouseover",function(){document.body.style.cursor="e-resize"});s.on("mouseout",function(){document.body.style.cursor="default"});this.konva.clipGroup.add(o,s)}if(r){l.on("mouseover",function(){document.body.style.cursor="e-resize"});l.on("mouseout",function(){document.body.style.cursor="default"});l.on("mousedown",function(e){var n=this.getName();d=e.evt.clientX;function i(e){h=e.clientX;var i=Math.round((h-d)/a.containerWidth*a.m_nTotalTime);var t=n.split("_")[1];if(i+a.clippedArr[t].endTime<=a.clippedArr[t].startTime){a.clippedArr[t].endTime=a.clippedArr[t].startTime}else{a.clippedArr[t].endTime+=i}a.drawClipBlock(a.konva.layer);a.konva.layer.batchDraw();d=h}document.onmousemove=i});this.konva.clipGroup.add(r,l)}}e.add(this.konva.clipGroup)};a.prototype.drawNoVideoBlock=function(e){var i=this.config.sectionArr;var t,n,a,o;var r=this.m_nBeginTime,s=this.m_nBeginTime+this.m_nTotalTime,l=this.m_nTotalTime;var c=0,m;for(var d=0,h=i.length;d<h;d++){m=c+i[d].duration;if(!i[d].status){if(c>=r&&m<=s){n=(c-r)/l*this.containerWidth;a=i[d].duration/l*this.containerWidth;t=new Konva.Rect({x:n,y:this.mainTopBottomMargin+20,width:a,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(10, 10, 10, 0.8)"})}else if(c<r&&m>r&&m<=s){n=0;a=(m-r)/l*this.containerWidth;t=new Konva.Rect({x:n,y:this.mainTopBottomMargin+20,width:a,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(10, 10, 10, 0.8)"})}else if(c>=r&&c<s&&m>s){n=(c-r)/l*this.containerWidth;a=this.containerWidth-n;t=new Konva.Rect({x:n,y:this.mainTopBottomMargin+20,width:a,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(10, 10, 10, 0.8)"})}else if(c<r&&m>s){n=0;a=this.containerWidth;t=new Konva.Rect({x:n,y:this.mainTopBottomMargin+20,width:a,height:this.containerHeight-this.mainTopBottomMargin*2-40,fill:"rgba(10, 10, 10, 0.8)"})}if(t){e.add(t)}if(a>50){o=new Konva.Text({x:n+a/2-25,y:this.containerHeight/2-8,text:"无录像",fontSize:16,fill:p});e.add(o)}}c=m}};a.prototype.drawIndex=function(i){var t=this;var e=this.m_nBeginTime+this.m_nTotalTime;var n,a;if(this.konva.indexGroup){this.konva.indexGroup.removeChildren()}for(var o=0,r=this.indexArr.length;o<r;o++){if(this.indexArr[o]>=this.m_nBeginTime&&this.indexArr[o]<=e){a=(this.indexArr[o]-this.m_nBeginTime)/this.m_nTotalTime*this.containerWidth;n=new Konva.Line({points:[a,this.mainTopBottomMargin+20,a,this.containerHeight-this.mainTopBottomMargin-20],stroke:"#ff6600",strokeWidth:4,name:"index_"+o});n.on("click",function(){var e=this.getName();if(!this.hasOwnProperty("checked")){this.checked=false}if(this.checked){this.setAttr("stroke","#ff6600");this.checked=false;t.konva.delIndexEle.splice(t.konva.delIndexEle.indexOf("."+e),1)}else{this.setAttr("stroke","#ff9900");this.checked=true;t.konva.delIndexEle.push("."+e)}i.draw()});this.konva.indexGroup.add(n)}}i.add(this.konva.indexGroup)};a.prototype.absToRel=function(e){var i=this.config.sectionArr;var t=0,n;for(var a=0,o=i.length;a<o;a++){n=t+i[a].duration;if(e>=t&&e<=n){return{id:i[a].id,time:e-t,absTime:e}}t=n}};a.prototype.relToAbs=function(e,i){var t=this.config.sectionArr;var n=0;for(var a=0,o=t.length;a<o;a++){if(e==t[a].id){return n+i}n+=t[a].duration}};a.prototype.eventInit=function(){var o=this;v("#timescale-play").on("click",function(e){var i=v(e.currentTarget).find(".iconfont");if(i.hasClass("icon-bofang")){v("#timescale-preview").find(".iconfont").removeClass("icon-zanting").addClass("icon-yulan");i.removeClass("icon-bofang");i.addClass("icon-zanting");o.emit("play")}else{i.removeClass("icon-zanting");i.addClass("icon-bofang");o.emit("pause")}});v("#timescale-preview").on("click",function(e){var i=[],t=[];var n=v(e.currentTarget).find(".iconfont");if(n.hasClass("icon-yulan")){v("#timescale-play").find(".iconfont").removeClass("icon-zanting").addClass("icon-bofang");n.removeClass("icon-yulan");n.addClass("icon-zanting");i=o.findVideoSection(o.clippedReverse(o.clippedArr));t=o.findVideoSection(o.clippedArr);o.emit("previewStart",i,t)}else{n.removeClass("icon-zanting");n.addClass("icon-yulan");o.emit("previewStop")}});v("#timescale-zoomIn").on("click",function(e){if(o.maxScale){return}if(o.scale===128){return}o.scale*=2;o.m_nTotalTime=o.aTotalTime/o.scale;if(o.currentTime>=o.m_nTotalTime/2&&o.aTotalTime-o.currentTime>=o.m_nTotalTime/2){o.m_nBeginTime=o.currentTime-o.m_nTotalTime/2}else if(o.currentTime<o.m_nTotalTime/2){o.m_nBeginTime=0}else if(o.aTotalTime-o.currentTime<o.m_nTotalTime/2){o.m_nBeginTime=o.aTotalTime-o.m_nTotalTime}o.konva.layer.removeChildren();o.drawLineF(o.konva.layer);if(o.config.showSectionStatus)o.drawNoVideoBlock(o.konva.layer);o.drawIndex(o.konva.layer);o.drawCursor(o.konva.layer);o.drawClipBlock(o.konva.layer);o.konva.layer.draw();var i=o.m_nBeginTime/o.aTotalTime*100;var t=o.m_nTotalTime/o.aTotalTime*100;v("#timescale-scroll-bar").attr("style","width:"+t+"%;left:"+i+"%")});v("#timescale-zoomOut").on("click",function(e){o.scale/=2;if(o.scale<1){o.scale=1;return}o.maxScale=false;o.m_nTotalTime=o.aTotalTime/o.scale;if(o.currentTime>=o.m_nTotalTime/2&&o.aTotalTime-o.currentTime>=o.m_nTotalTime/2){o.m_nBeginTime=o.currentTime-o.m_nTotalTime/2}else if(o.currentTime<o.m_nTotalTime/2){o.m_nBeginTime=0}else if(o.aTotalTime-o.currentTime<o.m_nTotalTime/2){o.m_nBeginTime=o.aTotalTime-o.m_nTotalTime}o.konva.layer.removeChildren();o.drawLineF(o.konva.layer);if(o.config.showSectionStatus)o.drawNoVideoBlock(o.konva.layer);o.drawIndex(o.konva.layer);o.drawCursor(o.konva.layer);o.drawClipBlock(o.konva.layer);o.konva.layer.draw();var i=o.m_nBeginTime/o.aTotalTime*100;var t=o.m_nTotalTime/o.aTotalTime*100;v("#timescale-scroll-bar").attr("style","width:"+t+"%;left:"+i+"%")});var n=0;var a=0;function i(e){var i=(e.clientX-a+n)/o.containerWidth*100;var t=parseFloat(d.getStyle(v("#timescale-scroll-bar")[0],"width"));if(i<=0){i=0}else if(i>=100-t/o.containerWidth*100){i=100-t/o.containerWidth*100}o.m_nBeginTime=o.aTotalTime*i/100;o.konva.layer.removeChildren();o.drawLineF(o.konva.layer);if(o.config.showSectionStatus)o.drawNoVideoBlock(o.konva.layer);o.drawIndex(o.konva.layer);o.drawCursor(o.konva.layer);o.drawClipBlock(o.konva.layer);o.konva.layer.batchDraw();v("#timescale-scroll-bar").css("left",i+"%")}v("#timescale-scroll-bar").on("mousedown",function(e){a=e.clientX;n=parseFloat(d.getStyle(v("#timescale-scroll-bar")[0],"left"));document.onmousemove=i});v(document).on("mouseup",function(e){document.onmousemove=null});v(".timescale .timescale-scroll-mouse-zoom").on("click",function(e){var i=e.clientX-e.currentTarget.getBoundingClientRect().left;var t=parseFloat(d.getStyle(v("#timescale-scroll-bar")[0],"width"));if(i>=o.containerWidth-t){i=o.containerWidth-t}o.m_nBeginTime=i/o.containerWidth*o.aTotalTime;o.konva.layer.removeChildren();o.drawLineF(o.konva.layer);if(o.config.showSectionStatus)o.drawNoVideoBlock(o.konva.layer);o.drawIndex(o.konva.layer);o.drawCursor(o.konva.layer);o.drawClipBlock(o.konva.layer);o.konva.layer.batchDraw();v("#timescale-scroll-bar").css("left",i/o.containerWidth*100+"%")});v("#timescale-clip-start").on("click",function(e){o.clipStart();o.drawClipBlock(o.konva.layer);o.konva.layer.draw()});v("#timescale-clip-end").on("click",function(e){o.clipEnd();o.drawClipBlock(o.konva.layer);o.konva.layer.draw()});v("#timescale-del").on("click",function(){var e=0;var t=[],n=[];for(var i=0,a=o.konva.delClipEle.length;i<a;i++){e=o.konva.delClipEle[i].split("_")[1];t.push(Number(e))}for(var i=0,a=o.konva.delIndexEle.length;i<a;i++){e=o.konva.delIndexEle[i].split("_")[1];o.emit("delIndex",o.absToRel(o.indexArr[e]));n.push(Number(e))}if(o.konva.delClipEle.length>0){o.clippedArr=o.clippedArr.filter(function(e,i){return t.indexOf(i)===-1});o.drawClipBlock(o.konva.layer)}if(o.konva.delIndexEle.length>0){o.indexArr=o.indexArr.filter(function(e,i){return n.indexOf(i)===-1});o.drawIndex(o.konva.layer)}o.konva.layer.draw();o.konva.delClipEle=[];o.konva.delIndexEle=[]});v("#timescale-clip").on("click",function(){var e=[],i=[];e=o.findVideoSection(o.clippedReverse(o.clippedArr));i=o.findVideoSection(o.clippedArr);o.emit("clip",e,i)});v("#timescale-index").on("click",function(){var e=o.currentTime;if(o.indexArr.indexOf(e)>-1){return}o.indexArr.push(e);o.drawIndex(o.konva.layer);o.konva.layer.draw();o.emit("createIndex",o.absToRel(e))})};a.prototype.findVideoSection=function(e){var i=this;var t=[],n=e,a=JSON.parse(JSON.stringify(i.config.sectionArr));var o=n.length,r=a.length;for(var s=0;s<o;s++){for(var l=0;l<r;l++){if(l===0){a[l].startTime=0;a[l].endTime=a[l].duration}else{a[l].startTime=a[l-1].endTime;a[l].endTime=a[l].startTime+a[l].duration}if(n[s].startTime>=a[l].startTime&&n[s].endTime<=a[l].endTime){t.push({section:[{id:a[l].id,startTime:n[s].startTime-a[l].startTime,endTime:n[s].endTime-a[l].startTime}],allStartTime:n[s].startTime,allEndTime:n[s].endTime});break}else if(n[s].startTime>=a[l].startTime&&n[s].endTime>a[l].endTime&&a[l].endTime>n[s].startTime){t.push({section:[{id:a[l].id,startTime:n[s].startTime-a[l].startTime,endTime:a[l].duration}],allStartTime:n[s].startTime,allEndTime:n[s].endTime})}else if(n[s].startTime<a[l].startTime&&n[s].endTime<=a[l].endTime){t[t.length-1].section.push({id:a[l].id,startTime:0,endTime:n[s].endTime-a[l].startTime});break}else if(n[s].startTime<a[l].startTime&&n[s].endTime>a[l].endTime){t[t.length-1].section.push({id:a[l].id,startTime:0,endTime:a[l].duration})}}}return t};a.prototype.clippedReverse=function(e){var i=e.length;var t=[];for(var n=0;n<i;n++){if(n===0){if(e[n].startTime!==0){t.push({startTime:0,endTime:e[n].startTime})}}if(n===i-1){if(e[n].endTime!==this.aTotalTime){t.push({startTime:e[n].endTime,endTime:this.aTotalTime})}}if(n<i-1){t.push({startTime:e[n].endTime,endTime:e[n+1].startTime})}}return t};a.prototype.clipStart=function(){var e=this.currentTime;for(var i=0,t=this.clippedArr.length;i<t;i++){if(e<this.clippedArr[i].startTime){this.clippedArr.splice(i,0,{startTime:e,endTime:this.clippedArr[i].startTime});break}else if(e>=this.clippedArr[i].startTime&&e<=this.clippedArr[i].endTime){this.clippedArr[i].startTime=e;break}}if(i==t){this.clippedArr.push({startTime:e,endTime:this.aTotalTime})}};a.prototype.clipEnd=function(){var e=this.currentTime;for(var i=0,t=this.clippedArr.length;i<t;i++){if(e<this.clippedArr[i].startTime){if(i===0){this.clippedArr.unshift({startTime:0,endTime:e})}else{this.clippedArr.splice(i,0,{startTime:this.clippedArr[i-1].endTime,endTime:e})}break}else if(e>=this.clippedArr[i].startTime&&e<=this.clippedArr[i].endTime){this.clippedArr[i].endTime=e;break}}if(i===t){this.clippedArr.push({startTime:this.clippedArr[t-1].endTime,endTime:e})}};a.prototype.emit=function(e){var i=[];for(var t=1,n=arguments.length;t<n;t++){i.push(arguments[t])}if(this.eventListObj.hasOwnProperty(e)){for(var t=0,n=this.eventListObj[e].length;t<n;t++){this.eventListObj[e][t].apply(null,i)}}};a.prototype.wait=function(i){var t=this;(function e(){t.konva.layer?i():setTimeout(e,100)})()};a.prototype.reload=function(e,i){var t=this;this.wait(function(){t.currentTime=0;t.clippedArr=[];t.indexArr=[];t.konva.layer.removeChildren();t.konva.staticLayer.removeChildren();t.konva.delClipEle=[];t.konva.delIndexEle=[];t.scale=1;v("#timescale-scroll-bar").css("width","100%").css("left","0");v("#timescale-play").find(".iconfont").removeClass("icon-zanting").addClass("icon-bofang");v("#timescale-preview").find(".iconfont").removeClass("icon-zanting").addClass("icon-yulan");t.timelineLoad(e,i)})};a.prototype.seekTo=function(a,o){var r=this;this.wait(function(){var e=0;var i=r.config.sectionArr;for(var t=0,n=i.length;t<n;t++){if(a==i[t].id){e+=o;break}else{e+=i[t].duration}}r.currentTime=e;r.drawCursor(r.konva.layer);r.konva.layer.batchDraw()})};a.prototype.play=function(){this.wait(function(){v("#timescale-play .iconfont").removeClass("icon-bofang").addClass("icon-zanting")})};a.prototype.pause=function(){this.wait(function(){v("#timescale-play .iconfont").removeClass("icon-zanting").addClass("icon-bofang")})};a.prototype.createIndex=function(e,i){var t=this;this.wait(function(){t.indexArr.push(t.relToAbs(e,i));t.drawIndex(t.konva.layer);t.konva.layer.draw()})};a.prototype.on=function(e,i){if(this.eventListObj.hasOwnProperty(e)){this.eventListObj[e].push(i)}else{this.eventListObj[e]=[i]}};a.prototype.off=function(e,i){if(this.eventListObj.hasOwnProperty(e)){for(var t=0,n=this.eventListObj[e].length;t<n;t++){if(this.eventListObj[e][t]===i){this.eventListObj[e].splice(t,1)}}}};a.prototype.init=function(){var e=this;e.frameInit();e.timelineLoad(e.config.sectionArr,e.config.clipsArr);e.eventInit()};a.prototype.timelineLoad=function(e,i){var t=this;var n=document.getElementById("timescale-main");var a=t.containerWidth=parseFloat(d.getStyle(n,"width"));var o=t.containerHeight=parseFloat(d.getStyle(n,"height"));var r=0;for(var s=0,l=e.length;s<l;s++){r+=e[s].duration}t.aTotalTime=r;v(".timescale .total-time").html(v.msToHMS(r));if(Array.isArray(i)){for(var s=0,l=i.length-1;s<l;s++){if(i[s].endTime<i[s+1].startTime){t.clippedArr.push({startTime:i[s].endTime,endTime:i[s+1].startTime})}}if(i.length==1){if(i[0].startTime>0){t.clippedArr.push({startTime:0,endTime:i[0].startTime})}else{t.clippedArr.push({startTime:i[0].endTime,endTime:r})}}}var c=new Konva.Rect({x:0,y:t.mainTopBottomMargin,width:a,height:o-t.mainTopBottomMargin*2,fill:h});t.konva.staticLayer.add(c);var m=new Konva.Line({points:[0,o/2-2,a,o/2-2],stroke:f,strokeWidth:4});t.konva.staticLayer.add(m);t.konva.staticLayer.draw();t.m_nTotalTime=t.aTotalTime;t.drawLineF(t.konva.layer);if(t.config.showSectionStatus)t.drawNoVideoBlock(t.konva.layer);t.drawIndex(t.konva.layer);t.drawCursor(t.konva.layer);t.drawClipBlock(t.konva.layer);t.konva.layer.draw()};a.prototype.frameInit=function(){var t=this;var e=document.getElementById(t.config.ele);var i="<div class='timescale-operation'>      <div class='timescale-timeshow'>        <span>当前：<span class='current-time'>00:00:00</span></span>        <span>总时长：<span class='total-time'>00:00:00</span></span>      </div>      <div class='timescale-operation-group'>        <span title='播放' id='timescale-play'><i class='iconfont icon-bofang'></i></span>"+(t.config.clipEnable?"<span title='预览' id='timescale-preview'><i class='iconfont icon-yulan'></i></span>":"")+"</div>"+(t.config.clipEnable||t.config.indexEnable?"<div class='timescale-operation-group'>"+(t.config.clipEnable?"<span title='入点' id='timescale-clip-start'><i class='iconfont icon-rudian'></i></span>        <span title='出点' id='timescale-clip-end'><i class='iconfont icon-chudian'></i></span>        <span title='剪辑' id='timescale-clip'><i class='iconfont icon-jianqie'></i></span>":"")+(t.config.indexEnable?"<span title='创建索引' id='timescale-index'><i class='iconfont icon-I'></i></span>":"")+"<span title='删除' id='timescale-del'><i class='iconfont icon-delete'></i></span>      </div>":"")+"<div class='timescale-operation-group'>        <span title='放大' id='timescale-zoomIn'><i class='iconfont icon-fangda'></i></span>        <span title='缩小' id='timescale-zoomOut'><i class='iconfont icon-suoxiao'></i></span>      </div>    </div>";var n="<div id='timescale-main'></div>";var a="<div id='timescale-scroll'>      <div id='timescale-scroll-bar'></div>      <div class='timescale-scroll-draggerRail'></div>      <div class='timescale-scroll-mouse-zoom'></div>    </div>";var o=i+n+a;if(v("#timescale-css").length==0){var r=document.createElement("style");r.type="text/css";r.id="timescale-css";r.innerHTML=".timescale{border-color:"+f+"}.timescale-operation{background-color:"+h+"}.timescale-operation .iconfont{color:"+f+"}.timescale-operation .timescale-timeshow>span{color:"+p+"}.timescale-operation .timescale-timeshow .current-time,.timescale-operation .timescale-timeshow .total-time{border-color:"+f+";-webkit-box-shadow: 0 0 5px 1px "+f+" inset;-moz-box-shadow: 0 0 5px 1px "+f+" inset;box-shadow: 0 0 5px 1px "+f+" inset;}.timescale-operation .timescale-operation-group{border-color:"+f+"}#timescale-scroll-bar{background-color:"+f+"}#timescale-main{border-color:"+f+"}.timescale-operation .timescale-operation-group span:hover{-webkit-box-shadow: 0 0 10px 1px "+f+" inset;-moz-box-shadow: 0 0 10px 1px "+f+" inset;box-shadow: 0 0 10px 1px "+f+" inset;}";v(document.head).append(r)}v(e).addClass("timescale");v(e).html(o);var s=document.getElementById("timescale-main");var l=t.containerWidth=parseFloat(d.getStyle(s,"width"));var c=t.containerHeight=parseFloat(d.getStyle(s,"height"));t.konva.stage=new Konva.Stage({container:"timescale-main",width:l,height:c});t.konva.layer=new Konva.Layer;t.konva.staticLayer=new Konva.Layer;t.konva.staticLayer.on("click",function(e){var i=(e.evt.layerX/t.containerWidth*t.m_nTotalTime+t.m_nBeginTime)/1e3;t.currentTime=Math.round(i)*1e3;t.drawCursor(t.konva.layer);t.konva.layer.draw();t.emit("seekTo",t.absToRel(t.currentTime))});this.konva.clipGroup=new Konva.Group;this.konva.indexGroup=new Konva.Group;t.konva.stage.add(t.konva.staticLayer,t.konva.layer)};l.render=function(e){var i=new a(e);return t.call(i)};window.timescale=l;l.ready()})();